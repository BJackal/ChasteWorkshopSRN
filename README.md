# Modelling cell-cell signalling with state reaction networks in Chaste

So-called 'sub-cellular reaction networks' (SRNs) can be used to mathematically model subcellular biological processes such as gene regulatory networks, protein-protein interactions, and signalling pathways. 
In Chaste, these processes may influence, and/or be influenced by, cellular behaviours such as proliferation, differentiation, adhesion, and motility, as well as cell-cell communication.
In this practical, you will investigate how to simulate two examples of cell-cell communication using SRNs in Chaste, building on the previous vertex model examples you looked at on Monday and Tuesday.

First you need to follow the steps outlined on the Chaste website for correctly initalizing a user project: https://chaste.cs.ox.ac.uk/trac/wiki/ChasteGuides/UserProjects
<!-- Replace previous sentence with link to whatever text is provided by Fergus on Tuesday for how to create, modify and clone user projects -->

<!-- Add sentence explaining that if they're using Chaste docker, then start it up, or equivalent if they're running Chaste natively. -->
 * Navigate to your Chaste projects folder: ```cd /path/to/Chaste/projects```
 * Clone this user project: ``` git clone https://github.com/BJackal/ChasteWorkshopSRN.git```
 * Navigate to the cloned user project from the command line and set it up: ```python setup_project.py```. This user project only relies on the cell-based Chaste, so answer `Y` to cell-based and `n` to lung and heart. 
 * Now you are ready to make sure that the user project will compile correctly. To do this, use the command line to navigate to the Chaste build folder (this should be outside of the main Chaste source folder) and run: ```ccmake path/to/Chaste```. <!-- Assuming they're running Chaste docker, tell them precisely where the build folder is --> While this is running, you will be prompted for an input to configure your user project. Press ```c ```, then on completion press ```e``` to exit. Next, configure with ```c``` once more, followed up by ```e``` to exit and finally ```g``` to generate. You are now ready to to make our tests. <!-- Go through the rest of the text and change "we" to "you" -->
 * To ensure that this has been done correctly, you can build the example test called `TestHello` and ensure that it passes. First, while within your build directory run ```make TestHello_ChasteWorkshopSRN``` and on completion you can run the example test using ```ctest -V -R TestHello_ChasteWorkshopSRN```. If this test succesfully makes and passes, youe know that the user project is compiled correctly. 

Here you will explore two examples of using SRN models in chaste. First, you will explore an example in Chaste of the Delta-Notch signalling pathway. Here you will utilise a modified version of Collier et als (1996, https://doi.org/10.1006/jtbi.1996.0233) work for the feedback loop between Delta and Notch. The one major difference in our system being that Delta concentrations in the neighbouring cells are used directly. Second, you will be able to investigate the formation of planar polarity in a 2D tissue based on a simplified version of the work of Fisher et al (2019, https://doi.org/10.1016/j.isci.2019.06.021).

# Example 1: Delta-Notch signalling
The test you will be following for this section can be found within ```/test/TestDeltaNotchSRN```. First, pen this file in visual studio code. You can look over the commented code describing what each line of text is being used for. 
All files will start out with relavent includes for which parts of Chaste you wish to utilise and this is also where you would include any of your own custom code that you may use in your own simulations.

For the first run through you will look at an edge based SRN model for a line of 70 cells. To run this simulation you first need to navigate to your ```/build``` directory.  Then in your console input ```make -j4 TestDeltaNotchSRN``` to make your simulation. Any time you alter your test you need to remember to make your test again. On completion execute ```ctest -V -R TestDeltaNotchSRN```, this will execute the test file and run your simulation. Once your test runs ssuccesfully you will need to utilise Paraview to explore your results. 

If you do not already have Paraview installed on your system, you can download it from the Paraview website here: https://www.paraview.org/download/

In Paraview first navigate to File -> Open. Then navigate to your test results folder, by default this should be /tmp/YourUserName/testoutput/TestDeltaNotchEdgeODESimulation. Opening the results_from_time_0.vtu file. Click the green apply button for your cells to appear. Then on the second row of the toolbar there will be two drop down menus defaulted to "Solid colour" and "Surface". You will need to change these to "edge delta" and "Surface With Edges". Finally, before playing the simulation you need to modify your colour bar for the entire time series of the simulation. To do this you can click the 6th button on the second row of the toolbars ( This should be a green arrow pointing in two directions with a small t) then click rescale when prompted withthe disable automatic rescaling option. Now you can play your simulation and watch how the edge based Delta evolves over time in the simulation. Similarlly, you can also change from your "edge delta" to "edge notch" to view how that also changes in time. 

If you wished to explore and plot how a given edges cocnentration of delta and notch changed in time you need to first click the "Select Cells On" button (This looks like a green triangle surrounded by a dotted box) then select your given edge of interest. In this example right most edge of the second cell conencting to its neigbhour has been selected. Now, navigate to Filters -> Data Analysis -> Plot Selection Over time. Then click the green apply button.This will create a graph showing all parameters on that edge, for now turn off all parameters except edge notch and edge delta. Now you can see how your concentrations of Delta and Notch evolve on this edge in time. You can try this across multiple edges between neighbours to see how each individual edge evolves in time.

For the second run of the simulation you can change your cells to be in a small tissue instead of a single line. To do this you will need change line 101 on our code from ```HoneycombVertexMeshGenerator generator (70,1)``` to  ```HoneycombVertexMeshGenerator generator (6,6)```. This will construct your cells in a 6 by 6 grid of cells instead of a single line. Re-run the simulation again using ```make -j4 TestDeltaNotchSRN``` and  ```ctest -V -R TestDeltaNotchSRN``` then view how this looks in paraview.  

In some case you may want to add proliferation and movement to your cells. To do this you will need to change a few sections of the underlying test file. First, you will need to change line 114 from ```NoCellCycleModel* p_cc_model = new NoCellCycleModel``` to ```UnifromG1GenerationCellCycleModel* p_cc_model = new UnifromG1GenerationCellCycleModel```. This means our cells will now have a stochastic cell cycle model, allowing for your cells to grow and divide based on their current phase. This will assign your cells phases for growth and division events from a uniform distribution. In addition, you will also need to add a target area modifier for your cells, to do this uncomment line 195 and 196 in your TestDeltaNotchSRN file. Finally, you will also need to add a force to your simulation to give your cells some movement, to do this uncomment line 192 and 193. This will pass a Farhardifar force to your cells. Now you are ready to run your simulation again. Still in your ```/build``` directory execute ```make -j4 TestDeltaNotchSRN``` and  ```ctest -V -R TestDeltaNotchSRN``` again as previously. This may take a little longer to run than previous due to the addition of cell proliferation in your system. Viewing the simulation results in paraview you will be able to see a much more dynamic system than in your first run case. In addition to cell movement and division you should also be able to find various types of cell transistions (T1, T2 etc ....).

You can further explore this test by trying different cell configurations. Simillarly you can also investigate how changing the initial conditions in your simulation, such as Delta and Notch, may lead to different end states for your simulation.

# Example 2: Planar polarity. 

Another use case for edge based SRN simulations is modelling planar polarity in epethelial tissues. Planar polarity(PP) is a form of protein mediated patterning across tissue due to signalling. Creating distinctive patterns across large length scales in many tissues. For example, in the wing of the Drasophila fruit fly wings there are many hairs across the wings used for sensory pruposes. These hairs have been noted to be all pointing from the proximal side of wings out towards the distal end. It has been found that there is a set of core proteins in the Drosophila wings which which create a simillar patterning on the cellular to tissue scale. This pattern is formed by two main proteins Frizzled(Fz) and Strabismus (Stb). These proteins then localise proximally and or distally based on positive feedback with their own species and ihibit the binding of the opposite protein on the same edge. Fz and Stb binding at cellular junctions to Flamingo (Fl) homodimers which bind across junctions.

Here you will investigate a simplified version in our simulation focusing on only three "protein" species: A, B and C. In our case you will assume that A can form homodimers with its own species in neighbouring cells edges and that B and C can then bind to these homodimers. First lets open up our test again, this can be found under /test/Test_Polarity. In addition, as you will be utilising some code for this simulation outside of the Chaste source doe you can find that you have several additional polarity files under ChasteWorkshopSRN/src. It is good practice to always keep any of your code which you will be editing as part of your project within this section and not directlly editing underlying Chaste source code. This is so if any issues arise it will be easier to ascertain if the new code or something else is causing the issue.

First lets open up our test again and take a look around. By default this test will utilise a 6 by 6 grid of cells and that you only initialise or simulation with the none bound Proteins A,B and C. This test utilises an "offset" for initalising our B concentration, this acts as an initial global signal for around 0.001% to be localised greater in the distall direction and less on the proximal edges.

Following previous steps, you can run the Polarity test by executing ```make -j4 TestPolaritySRN``` and on completion execute ```ctest -V -R TestPolaritySRN```. Then you can launch the simulation results in paraview and investigate how polarity forms across the tissue in time. You can use the previous methods described in Example 1 to investigate the evolution of the protein species over time and investiagte how the species interact with each other.

You can also edit the underlying source code for your test in the Chaste/projects/ChasteWorkShopSRN/src folder. For example, you can open PolarityEdgeTrackingModifier.cpp. This file contains several underlying functions for keeping track of cellular edge data. On line 38 you will find the class variable```mUnboundProteinDiffusionCoefficient(0.03)```. This represents the diffusion rates for your proteins and is utilised in the function ```UpdateCellData``` for diffusion of proteins around our cells edges. Try reducing or increasing this coefficient then save your changes to the file. Now that you have updated this underlying src file you will need to cmake our build folder again. To do this lets go back to our build folder (outside the main chaste soruce code folder) and run at command line ```cmake /path/to/Chaste/``` then ```make -j4 TestPolaritySRN``` and on completion execute ```ctest -V -R TestPolaritySRN```. Opening up the results in paraview what change if any do you find to the temoporal behavioru of the proteins compared to the original diffusion coefficient ?

In all of the tests so far cells have been on a uniform vertex mesh. In some cases you may wish to investigate the dynamics of cells on a more randomly distrubted mesh. For example, you could create cells which are randomly distibuted with their edges defined by a Voronoi teselation. To do this, re-open your ```TestPolaritySRN.hpp``` and comment out line 111 and repalce this with line 112. This will switch out your uniform vertex mesh for a Voronoi vertex mesh. This will create a dynamic mesh with cells edges defined based on distances from each others centres. Now re-run your simulation to view how this looks in paraview and compare it to the previous uniform mesh.

Simillar to in Example 1 you can also repalce your ```NoCellCycleModel* p_cc_model = new NoCellCycleModel``` with ```UnifromG1GenerationCellCycleModel* p_cc_model = new UnifromG1GenerationCellCycleModel```. You will also need to uncomment lines 202 - 206. This will allow your cells to grow and divide. On division, the new daughter cells edges will receive a portion of the concentration that existed on the dividing mother cells edge. By default this will be  

You could further explore this test by altering the initial conditions of our A,B and C concentrations. For example, how does your final simulation result change if you give none equal cocnentrations of the initial proteins ? How is the end result effected if you "flooded" the simulation with a higher initial cocnentraiton of the A homodimer forming protein. You could also try increasing or decreasing the initial bias caused by the offset. How does altering this effect your end results.


